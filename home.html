<!DOCTYPE html>
<html>
<body>
    <div id='app'></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
<script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
<script>

const ADD_TODO = 'ADD_TODO';
const REMOVE_TODO = 'REMOVE_TODO';
const TOGGLE_TODO = 'TOGGLE_TODO';
const ADD_GOAL = 'ADD_GOAL';
const REMOVE_GOAL = 'REMOVE_GOAL';

function addToDOAction(todo){
return {
    type: ADD_TODO,
    todo
}
}
function toggleTodoAction (id){
    return {
        type: TOGGLE_TODO,
        id
    }
}

function removeTodoAction(id){
    return {
        type: REMOVE_TODO,
        id
    }
}
function addGoalAction(goal){
    return {
        type: 'ADD_GOAL',
        goal
    }
}
function removeGoalAction(id){
    return {
        type: REMOVE_GOAL,
        id
    }
}
function todos(state = [],action){
switch(action.type){
    case ADD_TODO:
        return state.concat([action.todo]);
    case REMOVE_TODO:
        return state.filter((item) => item.id !== action.id)
    case TOGGLE_TODO:
        return state.map((todo) => todo.id !== action.id ? todo : 
        Object.assign({},todo,{complete: !todo.complete}));
    default:
        return state;
}
}

function goals(state = [],action){
switch(action.type){
    case ADD_GOAL:
        return state.concat([action.goal]);
    case REMOVE_GOAL :
        return state.filter((goal) => goal.id !== action.id)
    default :
        return state
}
}

function checker(store){
    return function(next){
        return function(action){
            if(action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')){
                return alert('No, No Bitcoin!');
            }

            if(action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')){
                return alert('No, No Bitcoin!');
            }

            if(action.type === ADD_GOAL){
                const result = next(action);
                alert('That\'s a great goal!');
                return result;
            }

            return next(action)
        }
    }
} 

const logger = (store) => (next) => (action) => {
    console.group(action)
        console.log('The action is ' , action.type);
        const result = next(action);
        console.log('The new state is: ', store.getState());
    console.groupEnd()
    return result
} 


const store = Redux.createStore(Redux.combineReducers({
    todos,
    goals
}),Redux.applyMiddleware(checker, logger))

{/* store.subscribe(() => {
    const {todos,goals} = store.getState();
    document.getElementById('todoList').innerHTML = ''
    document.getElementById('goalList').innerHTML = ''
    todos.forEach(addTodoToDOM);
    goals.forEach(addGoalToDOM);
}) */}

store.dispatch(addToDOAction({id: 0,name: 'Learn Redux',complete: false}))

//DOM functions
function generateID(){
    return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
}

</script>

<script type='text/babel'>
    function List(props){
        return(
            <ul>
                {props.items.map((item) => 
                <li key={item.id}>
                    <span onClick={() => props.toggle && props.toggle(item.id)}
                    style={{textDecoration:item.complete? 'line-through' : ''}}>{item.name}</span>
                    <button onClick={() => props.removeItem(item)}>X</button>
                </li>)}
            </ul>
        )
    }

    class Todos extends React.Component{
        addItem = (e) => {
            e.preventDefault();
            const name = this.input.value;
            this.input.value = '';
            this.props.store.dispatch(addToDOAction({
                id: generateID(),
                name,
                complete:false}));
        }
        removeItem = (item) => {
            this.props.store.dispatch(removeTodoAction(item.id));
        }
        toggleItem = (id) => {
            this.props.store.dispatch(toggleTodoAction(id));
        }
        render(){
            return (
                <div>
                    <h1>Todos List</h1>
                    <input
                    type='text'
                    placeholder='Enter your todo'
                    ref={(input) => this.input = input}
                    />
                    <button onClick={this.addItem}>Add Todo</button>
                    <List items={this.props.todos} removeItem={this.removeItem} toggle={this.toggleItem}/>
                </div>
            )
        }
    }

    class Goals extends React.Component{
        addItem = (e) => {
            e.preventDefault();
            const name = this.input.value;
            this.input.value = '';

            this.props.store.dispatch(addGoalAction({
                id: generateID(),
                name,
                complete:false}));
        }
        removeItem = (item) => {
            this.props.store.dispatch(removeGoalAction(item.id));
        }
        render(){
            return (
                <div>
                    <h1>Goals List</h1>
                    <input
                    type='text'
                    placeholder='Add Goal'
                    ref= {(input) => this.input = input}
                    />
                    <button onClick={this.addItem}>Add Goal</button>
                    <List items={this.props.goals} removeItem={this.removeItem}/>
                </div>
            )
        }
    }
    class App extends React.Component{
        componentDidMount(){
            const {store} = this.props;

            store.subscribe(() => this.forceUpdate());
        }
        render(){
            const {store} = this.props;
            const {todos,goals} = store.getState();
            return(
                <div>
                    <Todos todos= {todos} store = {this.props.store}/>
                    <Goals goals= {goals} store = {this.props.store}/>    
                </div>
            )
        }
    }

    ReactDOM.render(<App store = {store}/> ,
        document.getElementById('app')
    )
</script>
</html>